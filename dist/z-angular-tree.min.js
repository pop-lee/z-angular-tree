angular.module("z.angular.tree",[]).constant("treeConfig",{templateUrl:"zangular/template/zTreeTemplate.html"}).directive("zTree",["$timeout",function(e){return{restrict:"AE",template:"<div z-tree-node-children></div>",scope:{zTree:"=?",treeData:"=",currentSelect:"=?",options:"=?"},transclude:!0,controller:["$scope",function(n){n.$nodeChildren=[],n.$nodeMap={},n.$keyCount=0,n.currentSelect instanceof Array||(n.currentSelect=[]),n.$oldCurrentSelect=[],n.options=angular.extend({childrenField:"children",leafNodeCanSelect:!0,canMultiple:!0,useToggle:!1,defaultCollapsed:!1},n.options),n.hasSelectNodeScopeList=[],n.node={},n.$watch("treeData",function(e){n.node[n.options.childrenField]=e,o(n.node,function(e){e.$$_key||(e.$$_key=++n.$keyCount)})},!0),n.$watchCollection("hasSelectNodeScopeList",function(e,n){var o;if(n)for(o=0;o<n.length;o++)n[o].$model.$hasSelect=!1;if(e)for(o=0;o<e.length;o++)e[o].$model.$hasSelect=!0}),n.$watchCollection("currentSelect",function(e){var o,t=n.$oldCurrentSelect;for(o=0;o<t.length;o++){var r=l(t[o]);r&&(r.$model.$selected=!1)}var d=[];for(o=0;o<e.length;o++){var c=l(e[o]);c&&(c.$model.$selected=!0,d.push(c),i(c,function(e){d.push(e)}))}n.hasSelectNodeScopeList=d,n.$oldCurrentSelect=[].concat(e)},!0),n.zTree={},n.zTree.selectNode=function(e){var o=l(e);n.options.leafNodeCanSelect?a(o)&&t(e):t(e)},n.zTree.addChildNode=function(o,t){var r=t[n.options.childrenField];null!=r&&void 0!=r&&r.push(o),e(function(){u(l(o))})},n.zTree.addNode=function(e,o){if(void 0===o)n.treeData.push(e);else{var t=l(o),r=t.$parentNodeScope.node,d=r[n.options.childrenField];d.splice($.inArray(o,d)+1,0,e)}},n.zTree.delNode=function(o,t){var r,d=l(o),i=d.$parentNodeScope.node,a=i[n.options.childrenField];r=t?t:$.inArray(o,a),a.splice(r,1),d.$parentNodeScope.$nodeChildren.splice(r,1),c(d,function(e){e.$model.$selected&&n.currentSelect.splice($.inArray(e.node,n.currentSelect),1),delete n.$nodeMap[e.$nodeKey]}),e(function(){s(d.$parentNodeScope)})},n.zTree.toggle=function(e){var n=l(e);n&&(n.$model.$collapsed?u(n):p(n))},n.options.useToggle||(n.zTree.expandAll=function(e){var n=l(e);c(n,function(e){e.$model.$collapsed=!1})},n.zTree.collapseAll=function(e){var n=l(e);c(n,function(e){e.$model.$collapsed=!0})});var o=function(e,t){void 0===e[n.options.childrenField]&&(e[n.options.childrenField]=[]);var l,r=e[n.options.childrenField];for(l=0;l<r.length;l++){var e=r[l];t(e),o(e,t)}},t=function(e){if(l(e)){var o=$.inArray(e,n.currentSelect);o>=0?n.currentSelect.splice(o,1):n.currentSelect.push(e)}},l=function(e){if(null===e||void 0===e)return null;for(var o in n.$nodeMap)if(n.$nodeMap[o].node==e)return n.$nodeMap[o];return null},r=function(e,n){if(void 0!==e&&null!==e)for(var o=e.$parentNodeScope,t=o.$nodeChildren.length,l=0;t>l;l++){var r=n(o.$nodeChildren[l]);if("return"===r)return r}},d=function(e,n){if(void 0!==e&&null!==e)for(var o=e.$nodeChildren.length,t=0;o>t;t++){var l=n(e.$nodeChildren[t]);if("return"===l)return l}},c=function(e,n){var o=n(e);return"return"===o?o:d(e,function(e){return c(e,n)})},i=function(e,o){var t=e.$parentNodeScope;t!==n&&(o(t),i(t,o))},a=function(e){return 0===e.$nodeChildren.length},p=function(e){e.$model.$collapsed=!0},u=function(e){e.$model.$collapsed&&(n.options.useToggle&&r(e,function(n){n!==e&&p(n)}),e.$parentNodeScope.$model&&u(e.$parentNodeScope),a(e)||(e.$model.$collapsed=!1))},s=function(e){for(var n=e.$nodeChildren,o=0;o<n.length;o++){var t=n[o];t.$model.$index=t.$internalScope.$index,t.$model.$isFirst=t.$internalScope.$first,t.$model.$isLast=t.$internalScope.$last,t.$model.$isMiddle=t.$internalScope.$middle}};this.$treeRootScope=n}],compile:function(e,n,o){return function(e,n,t,l){e.transclude=o}}}}]).directive("zTreeNodeChildren",["$compile","$templateCache","treeConfig",function(e,n,o){return{restrict:"AE",template:'<div class="z-tree-node-children" ng-class="{\'collapsed\':$model.$collapsed}">',replace:!0,scope:!0,controller:function(){var t=n.get(o.templateUrl);this.template=e(t)},link:function(e,n,o,t){t.template(e,function(e){n.html("").append(e)})}}}]).directive("zTreeNode",function(){return{require:"^zTree",link:function(e,n,o,t){var l=t.$treeRootScope;e.transcludeScope=l.$parent.$new(),e.transcludeScope.$nodeChildren=[],e.transcludeScope.$parentNodeScope=e.$parent.$parent,e.transcludeScope.$internalScope=e,e.transcludeScope.node=e.node,e.transcludeScope.options=l.options,e.transcludeScope.$nodeKey=e.node.$$_key,e.transcludeScope.$model={$index:e.$index,$isFirst:e.$first,$isLast:e.$last,$isMiddle:e.$middle,$collapsed:0===e.node.children.length?!0:l.options.defaultCollapsed,$hasSelect:!1,$selected:!1,$nodeLevel:e.$parent.$parent.$model?e.$parent.$model.$nodeLevel+1:1};var r=$.inArray(e.transcludeScope.node,e.transcludeScope.$parentNodeScope.node[l.options.childrenField]);e.transcludeScope.$parentNodeScope.$nodeChildren.splice(r,0,e.transcludeScope),l.$nodeMap[e.transcludeScope.$nodeKey]=e.transcludeScope,l.transclude(e.transcludeScope,function(e){n.html("").append(e)}),e.$on("$destroy",function(){e.transcludeScope.$destroy()})}}}),angular.module("z.angular.tree").run(["$templateCache",function(e){e.put("zangular/template/zTreeTemplate.html",'<ul class="nav"><li ng-repeat="node in node[options.childrenField] track by node.$$_key"><div z-tree-node="" class="z-tree-node"></div></li></ul>')}]);