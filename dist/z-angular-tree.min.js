angular.module("z.angular.tree",[]).constant("treeConfig",{templateUrl:"zangular/template/zTreeTemplate.html"}).directive("zTree",["$timeout",function(e){return{restrict:"AE",template:"<div z-tree-node></div>",scope:{zTree:"=?",treeData:"=",currentSelect:"=?",options:"=?"},transclude:!0,controller:["$scope",function(n){n.$nodeChildren=[],n.$nodeMap={},n.options=angular.extend({childrenField:"children",leafNodeCanSelect:!0,canMultiple:!1,useToggle:!0},n.options),n.hasSelectNodeScopeList=[],n.$watch("hasSelectNodeScopeList",function(e,n){var t,o;if(n)for(o=n.length,t=0;o>t;t++)n[t].$model.$hasSelect=!1;if(e)for(o=e.length,t=0;o>t;t++)e[t].$model.$hasSelect=!0}),n.$watch("currentSelect",function(e,o){var r=t(e),l=t(o);if(l&&(l.$model.$selected=!1),r){r.$model.$selected=!0;var d=[];d.push(r),c(r,function(e){d.push(e)}),n.hasSelectNodeScopeList=d}}),n.node={},n.node[n.options.childrenField]=n.treeData,this.$treeRootScope=n,n.zTree={},n.zTree.selectNode=function(e){var o=t(e);n.options.canMultiple||(a(o)?n.currentSelect=o.node:n.options.leafNodeCanSelect||(n.currentSelect=o.node))},n.zTree.addChildNode=function(o,r){if(null!=r){var l=r[n.options.childrenField];null!=l&&void 0!=l&&l.push(o)}else n.treeData.push(o);e(function(){p(t(o))})},n.zTree.addAfterNode=function(e,o){var r=t(o),l=r.$parentNodeScope.node,c=l[n.options.childrenField];c.splice($.inArray(o,c)+1,0,e)},n.zTree.delNode=function(e,o){var r,c=t(e),d=c.$parentNodeScope.node,a=d[n.options.childrenField];r=o?o:$.inArray(e,a),a.splice(r,1),c.$parentNodeScope.$nodeChildren.splice(r,1),l(c,function(e){delete n.$nodeMap[e.node.$$hashKey]})},n.zTree.toggle=function(e){var n=t(e);n&&(n.$model.$collapsed?p(n):u(n))},n.options.canMultiple&&(n.zTree.expandAll=function(e){var n=t(e);l(n,function(e){e.$model.$collapsed=!1})},n.zTree.collapseAll=function(e){var n=t(e);l(n,function(e){e.$model.$collapsed=!0})});var t=function(e){return null===e||void 0===e?null:n.$nodeMap[e.$$hashKey]},o=function(e,n){if(void 0!==e&&null!==e)for(var t=e.$parentNodeScope,o=t.$nodeChildren.length,r=0;o>r;r++){var l=n(t.$nodeChildren[r]);if("return"===l)return l}},r=function(e,n){if(void 0!==e&&null!==e)for(var t=e.$nodeChildren.length,o=0;t>o;o++){var r=n(e.$nodeChildren[o]);if("return"===r)return r}},l=function(e,n){var t=n(e);return"return"===t?t:r(e,function(e){return l(e,n)})},c=function(e,t){var o=e.$parentNodeScope;o!==n&&(t(o),c(o,t))},d=function(e,t){t||(t=n);var o=null;return l(t,function(n){return n===e?(o=n,"return"):void 0}),o},a=function(e){return 0===e.$nodeChildren.length},i=function(e){return void 0!=d(t(n.currentSelect),e)?!0:!1},u=function(e){i(e)&&(n.hasSelectNodeScope=e),e.$model.$collapsed=!0},p=function(e){e.$model.$collapsed&&(n.options.useToggle&&o(e,function(n){n!==e&&u(n)}),e.$parentNodeScope.$model&&p(e.$parentNodeScope),a(e)||(e.$model.$collapsed=!1))}}],compile:function(e,n,t){return function(e,n,o,r){e.transclude=t}}}}]).directive("zTreeNode",["$compile","$templateCache","treeConfig",function(e,n,t){return{restrict:"AE",scope:!0,controller:function(){var o=n.get(t.templateUrl);this.template=e(o)},link:function(e,n,t,o){o.template(e,function(e){n.html("").append(e)})}}}]).directive("zTreeTransclude",function(){return{require:"^zTree",link:function(e,n,t,o){var r=o.$treeRootScope;e.transcludeScope=r.$parent.$new(),e.transcludeScope.$nodeChildren=[],e.transcludeScope.$parentNodeScope=e.$parent.$parent,e.transcludeScope.node=e.node,e.transcludeScope.options=r.options,e.transcludeScope.$model={$nodeLevel:0,$collapsed:!0,$hasSelect:!1,$selected:!1,$nodeLevel:e.$parent.$parent.$model?e.$parent.$model.$nodeLevel+1:1},e.transcludeScope.$parentNodeScope.$nodeChildren.push(e.transcludeScope),e.$on("$destroy",function(){e.transcludeScope.$destroy()}),r.$nodeMap[e.node.$$hashKey]=e.transcludeScope,r.transclude(e.transcludeScope,function(e){n.html("").append(e)})}}}),angular.module("z.angular.tree").run(["$templateCache",function(e){e.put("zangular/template/zTreeTemplate.html",'<ul class="nav"><li ng-repeat="node in node[options.childrenField]" class="z-tree-node"><div z-tree-transclude=""></div></li></ul>')}]);